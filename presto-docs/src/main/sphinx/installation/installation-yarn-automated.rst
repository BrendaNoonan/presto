==============================================
Automated Installation on a YARN-Based Cluster
==============================================

If you are planning to use HDP distribution, you can use Ambari and 
`Apache Slider`_. to perform automated Presto installation and 
integration on a YARN-based cluster. During installation, both the 
Apache Slider package and Presto are installed.


.. contents:: Installing and Integrating Presto with YARN

Deploying Presto on a YARN-Based Cluster
========================================

The installation procedures assume that you have a basic knowledge of Presto
and the configuration files and properties it uses.

.. note::

  All example files referred to are from:
  https://github.com/prestodb/presto-yarn/

Pre-Requisites
--------------

-  A cluster with HDP 2.2+ or CDH5.4+ installed
-  Apache Slider 0.80.0 (download from https://slider.incubator.apache.org/)
-  JDK 1.8
-  Zookeeper
-  openssl >= 1.0.1e-16
-  Ambari 2.1

  .. _Package: https:www.teradata.com/presto
  .. _Apache slider: https://slider.incubator.apache.org/

.. 
  BELOW CONTENT IS GENERATED BY PANDOC FROM PRESTO-YARN README.md file, except
  - added pre-requisities section
  - inner links got fixed
  - links section updates
  - added note where example files are stored

Presto Installation Directory Structure
---------------------------------------

When you use Ambari Slider View to install Presto on a YARN-based cluster, the 
Presto installation directory structure differs from the standard structure.

For more information, see:

| :doc:`Presto Installation Directory Structure for YARN-Based Clusters <installation-yarn-directory-structure>`

Presto Installation Configuration Options
-----------------------------------------

During installation, Ambari Slider View allows you to select configuration 
options required for running Presto.

For more information, see:

| :doc:`Presto Configuration Options for YARN-Based Clusters <installation/installation-yarn-configuration-options>`


Using Ambari Slider View to Install Presto on a YARN-Based Cluster 
==================================================================

Ambari supports deploying Slider application packages using Slider View and 
provides Slider integration. Slider View for Ambari allows you to deploy and 
manage Slider apps from Ambari Web.

The steps for deploying Presto on YARN using Slider View in Ambari are:

1.  Install the Ambari server. See:
    http://docs.hortonworks.com/HDPDocuments/Ambari-2.1.0.0/bk_Installing_HDP_AMB/content/ch_Installing_Ambari.html.

2.  Download the Apache Slider package. See:
    https://slider.incubator.apache.org/

3.  Copy the Presto app package
    ``presto-yarn-package-<version>-<presto-version>.zip`` to
    ``/var/lib/ambari-server/resources/apps/`` directory on your Ambari
    server node. Restart ambari-server.

4.  Now Log In to Apache Ambari, ``http://ambariserver_ip:8080``
    #username-admin password-admin

5.  Name your cluster, provide the configuration of the cluster and
    follow the steps on the WebUI.

6.  Customize/configure the services and install them. A minimum of HDFS,
    YARN, Zookeeper is required for Slider to work. You must also also
    select Slider to be installed.

7.  For the Slider client installed, you need to update its configuration if
    you are not using the default installation paths for Hadoop and Zookeeper.
    Thus ``slider-env.sh`` should point to your JAVA\_HOME and HADOOP\_CONF\_DIR

::

        export JAVA_HOME=/usr/lib/jvm/java
        export HADOOP_CONF_DIR=/etc/hadoop/conf

8.  For zookeeper, if you are using a different installation directory from the
    default one at ``/usr/lib/zookeeper`` add a custom property to ``slider-client`` section
    in Slider configuration with key: ``zk.home`` and value: ``path_to_your_zookeeper``.
    If using a different  port from default one ``2181`` then add key: ``slider.zookeeper.quorum``
    and value: ``master:5181`` where ``master`` is the node and ``5181`` is the  port.

9.  Once you have all the services up and running on the cluster, you can
    configure Slider in Ambari to manage your application by creating a
    "View". Go to ``admin`` (top right corner) -> ``Manage Ambari`` and
    then from the left pane select ``Views``.

10. There, create a Slider View by populating all the necessary fields
    with a preferred instance name (eg: Slider). ``ambari.server.url``
    can be of the format -
    ``http://<ambari-server-url>:8080/api/v1/clusters/<clustername>``,
    where ``<clustername>`` is what you have named your Ambari cluster.

11. Select the "Views" control icon in the upper right, select the
    instance you created in the previous step, eg: "Slider".

12. Now click ``Create App`` to create a new Presto YARN application.

13. Provide details of the Presto service. By default, the UI will be
    populated with the values you have in the ``*-default.json`` files in
    your ``presto-yarn-package-*.zip``.

14. The app name should be of lower case, eg: presto1.

15. You can set the configuration property fields as per your cluster requirement. For example,
    if you want to set a connector for Presto, you can update the ``global.catalog`` property. See
    `section <#presto-app-package-configuration>`__ for explanation on each configuration
    property.

16. Prepare HDFS for Slider. The user directory you create here should be
    for the same user you set in ``global.app_user`` field. If the
    ``app_user`` is going to be ``yarn`` then do:

::

    su hdfs hdfs dfs -mkdir -p /user/yarn 
    su hdfs hdfs dfs -chown yarn:yarn /user/yarn

17. Make sure you change the ``global.presto_server_port`` from 8080 to
    some other unused port eg;8089, since Ambari by default uses 8080.

18. Make sure the data directory in the UI (added in
    ``appConfig-default.json`` eg: ``/var/lib/presto/``) is pre-created
    on all nodes and the directory must be owned by ``global.app_user``,
    otherwise slider will fail to start Presto with permission errors.

::

    mkdir -p /var/lib/presto/data
    chown -R yarn:hadoop /var/lib/presto/data

19. If you want to add any additional Custom properties, use Custom
    property section. Additional properties supported as of now are
    ``site.global.plugin``, ``site.global.additional_config_properties``
    and ``site.global.additional_node_properties``. See
    `section <#presto-app-package-configuration>`__ for requirements and format of
    these properties.

20. Click Finish. This will basically do the equivalent of
    ``package  --install`` and ``create`` you do via the bin/slider
    script. Once successfully deployed, you will see the Yarn application
    started for Presto. You can click on app launched, and then if monitor the 
    status either from Slider view or you can click on the ``Quick Links`` which
    should take you to the YARN WebUI. If your application is successfully run, it 
    should continuously be available in the YARN resource manager as a "RUNNING" application.

21. If the job fails, please be sure to check the job history’s logs along with the logs on the node’s disk. 
    Refer `this <#debugging-and-logging>`__ section for more details.

22. You can manage the application lifecycle (e.g. start, stop, flex,
    destroy) from the View UI.

Additional Configuration Options
================================

After you install Presto and Slider, you can reconfigure presto or perform 
additional configuration.

Reconfiguring Presto in Slider View
-----------------------------------

After you launch Presto you can update its configuration. For example, you
can add a new connector.

1. On the Slider View instance screen, go to ``Actions.``
2. Stop the running Presto application.
3. Click `Destroy`` to remove the existing Presto instance running in Slider.
4. Click the ``Create App`` button to re-create a new Presto instance in Slider 
   and make configuration updates.

Advanced Configuration Options
------------------------------

The following advanced configuration options are available:

+ Configuring memory, CPU, and YARN CGroups
+ Failure policy
+ YARN label

For more information, see:

| :doc:`Advanced Configuration Options for YARN-Based Clusters <installation-yarn-configuration-options-advanced>`

Debugging and Logging
=====================

For more information, see:

| :doc:`Debugging and Loggin for YARN-Based Clusters <installation-yarn-debugging-logging>`

Links
=====

-  https://github.com/prestodb/presto-yarn/blob/master/README.md
-  http://slider.incubator.apache.org/docs/getting\_started.html
-  http://docs.hortonworks.com/HDPDocuments/Ambari-2.0.1.0/bk\_Installing\_HDP\_AMB/content/ch\_Installing\_Ambari.html
